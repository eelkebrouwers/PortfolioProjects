/*select *
from PortfolioProjectCovid.dbo.CovidVaccinations
order by 3,4*/

select *
from PortfolioProjectCovid.dbo.CovidDeaths
order by 3,4

-- looking at Total cases vs Total deaths 
-- Shows the percentage of infected people who died
select Location, date, total_cases, total_deaths, population,
(total_deaths/total_cases)*100 AS PercentageCovidDeaths
from PortfolioProjectCovid.dbo.CovidDeaths
-- WHERE Location like '%Netherland%' AND date like '2020%'
order by 1,2

-- looking at Total cases vs Population
-- shows what percentage of the population got Covid
select Location, date, total_cases, population, (total_cases/population)*100 AS PercentageInfected
from PortfolioProjectCovid.dbo.CovidDeaths
WHERE Location like '%Netherland%' 
order by 1,2

-- Looking at countries with highest infection rate compared to population
select Location, population, MAX(total_cases) AS HighestInfectionCount, MAX((total_cases/population))*100 AS PercentageInfected
from PortfolioProjectCovid.dbo.CovidDeaths
group by location, population
order by PercentageInfected DESC

-- Showing countries with highest death count per population
select location, population, MAX(total_deaths) AS HighestDeathCount, MAX((total_deaths/population))*100 AS PercentageDeathPopulation
from PortfolioProjectCovid.dbo.CovidDeaths
WHERE continent is not NULL
group by location, population
order by PercentageDeathPopulation DESC

-- Showing continents with highest death count per population
select continent, MAX(total_deaths) AS HighestDeathCount, MAX((total_deaths/population))*100 AS PercentageDeathPopulation
from PortfolioProjectCovid.dbo.CovidDeaths
WHERE continent is not NULL
group by continent
order by PercentageDeathPopulation DESC


-- global numbers. So basically the data per date for all countries together. 
select date, SUM(new_cases) AS TotalCasesGlobal, SUM(new_deaths) AS TotalDeathsGlobal, (SUM(new_deaths)/SUM(new_cases))*100 AS PercentageDeathGlobal
from PortfolioProjectCovid.dbo.CovidDeaths
WHERE continent is not NULL
group by date
order by 1,2

--Total population versus Vaccination 
select death.location, death.date, death.population, vaccination.total_vaccinations, (vaccination.total_vaccinations/death.population)*100 AS PercentageVaccinated
from PortfolioProjectCovid.dbo.CovidDeaths death
JOIN PortfolioProjectCovid.dbo.CovidVaccinations vaccination
    ON death.location = vaccination.location 
    AND death.date = vaccination.date 
WHERE death.location LIKE 'Netherlands'
ORDER BY 1,2

-- Looking at vaccinations. 
-- Just double checking whether the PercentageVaccinated is no longer following PercentageVaccinations when the first FullyVaccinated people start appearing
select death.location, death.date, death.population, vaccination.total_vaccinations, 
(vaccination.total_vaccinations/death.population)*100 AS PercentageVaccinations,
(vaccination.people_vaccinated/death.population)*100 AS PercentageVaccinated,
(vaccination.people_fully_vaccinated/death.population)*100 AS PercentageFullyVaccinated
from PortfolioProjectCovid.dbo.CovidDeaths death
JOIN PortfolioProjectCovid.dbo.CovidVaccinations vaccination
    ON death.location = vaccination.location 
    AND death.date = vaccination.date 
WHERE death.location LIKE 'Netherlands'
ORDER BY 1,2

-- Use CTE
With PopvsVac (continent, location, date, population, new_vaccinations, TotalPeopleVaccinated)
as 
(
-- Looking at sum new vaccinations. Over Partition by location, because we are breaking it up, so that everytime a new location start we want it to restart counting 
select death.continent, death.location, death.date, death.population, vaccination.new_vaccinations, 
SUM(CONVERT(float,vaccination.new_vaccinations)) OVER (Partition by death.location ORDER BY death.location, death.date) AS TotalPeopleVaccinated
--(TotalPeopleVaccinated/population)*100
from PortfolioProjectCovid.dbo.CovidDeaths death
JOIN PortfolioProjectCovid.dbo.CovidVaccinations vaccination
    ON death.location = vaccination.location 
    AND death.date = vaccination.date 
WHERE death.continent is not NULL
-- WHERE death.location LIKE 'Netherlands'
-- ORDER BY 2,3
)
Select *, (TotalPeopleVaccinated/population)*100 
from PopvsVac

-- Use Temp table
drop table if exists #PercentPopulationVaccinated
Create Table #PercentPopulationVaccinated
(
    continent nvarchar(255),
    location nvarchar(255),
    date datetime,
    population numeric,
    new_vaccinations numeric,
    TotalPeopleVaccinated numeric,
)

insert into #PercentPopulationVaccinated
-- Looking at sum new vaccinations. Over Partition by location, because we are breaking it up, so that everytime a new location start we want it to restart counting 
select death.continent, death.location, death.date, death.population, vaccination.new_vaccinations, 
SUM(CONVERT(float,vaccination.new_vaccinations)) OVER (Partition by death.location ORDER BY death.location, death.date) AS TotalPeopleVaccinated
--(TotalPeopleVaccinated/population)*100
from PortfolioProjectCovid.dbo.CovidDeaths death
JOIN PortfolioProjectCovid.dbo.CovidVaccinations vaccination
    ON death.location = vaccination.location 
    AND death.date = vaccination.date 
WHERE death.continent is not NULL
-- WHERE death.location LIKE 'Netherlands'
-- ORDER BY 2,3

Select *, (TotalPeopleVaccinated/population)*100 
from #PercentPopulationVaccinated
order by 2,3

-- Create view to store data for later visualizations
Create View PercentPopulationVaccinated AS
select death.continent, death.location, death.date, death.population, vaccination.new_vaccinations, 
SUM(CONVERT(float,vaccination.new_vaccinations)) OVER (Partition by death.location ORDER BY death.location, death.date) AS TotalPeopleVaccinated
--(TotalPeopleVaccinated/population)*100
from PortfolioProjectCovid.dbo.CovidDeaths death
JOIN PortfolioProjectCovid.dbo.CovidVaccinations vaccination
    ON death.location = vaccination.location 
    AND death.date = vaccination.date 
WHERE death.continent is not NULL
-- WHERE death.location LIKE 'Netherlands'
-- ORDER BY 2,3